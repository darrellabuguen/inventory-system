<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./design.css">
    <link rel="stylesheet" href="./responsive.css">

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
        crossorigin="anonymous"></script>

    <title>Inventory System | Inventory</title>
</head>

<body>
    <header>
        <div class="web-name">Store Inventory</div>
        <div class="signout-contain"><button class="pwr_bttn"><img class="pwr_icon signout"
                    src="./images/power_icon.png" alt="img"></button></div>
    </header>
    <main>
        <div class="item-display">
            <div class="category-container">
                <div class="container" onclick="window.location='./category/beverages.html'">
                    <label class="category-label">Beverage</label>
                    <div class="beverage-image">
                        <img src="./images/wine-bottle-solid.svg" alt="image">
                    </div>
                </div>
                <div class="container" onclick="window.location='./category/frozen-foods.html'">
                    <label class="category-label">Frozen Food</label>
                    <div class="frozen-image">
                        <img src="./images/ice-cream-solid.svg" alt="image">
                    </div>
                </div>
                <div class="container" onclick="window.location='./category/health&wellness.html'">
                    <label class="category-label">Health & Wellness</label>
                    <div class="hw-image">
                        <img src="./images/wellness.svg" alt="image">
                    </div>
                </div>
                <div class="container" onclick="window.location='./category/pantry.html'">
                    <label class="category-label">Pantry</label>
                    <div class="pantry-image"></div>
                </div>
            </div>
            <div class="items-container">
                <div class="nav-title">
                    <p class="title-nav">All Items</p>
                </div>
                <div class="search-container">
                    <input class="search" type="search" name="search">
                    <button class="search-button"><img class="search-icn" src="./images/search_icon.png"
                            alt="img"></button>
                    <div class="add-bottom">
                        <button class="add-item-bottom"><img class="bttm-add" src="./images/add_icon.png"
                                alt="img"></button>
                    </div>
                </div>
                <div class="table-container" style="display: none;">
                    <table class="items">
                        <thead>
                            <th>Item ID</th>
                            <th>Item Name</th>
                            <th>Item Price</th>
                            <th>Manufactured Date</th>
                            <th>Expiration Date</th>
                            <th>Date Added</th>
                        </thead>
                        <tbody class="item-body">
                            <tr></tr>
                        </tbody>
                    </table>
                </div>
                <div class="chart-container">
                    <h2 align="center">Items</h2>
                    <canvas id="myChart"></canvas>
                </div>
            </div>
        </div>

        <div class="add-item-section">
            <div class="add-item-container">
                <div class="add-item-text">Add Item</div>
                <input class="item-name" required type="text" placeholder="Item name...">
                <input class="item-price" required type="text" placeholder="Item price...">
                <label for="category">Category</label><br>
                <select name="categories" id="category" onchange="checkCategory(this.id)">
                    <option value="Beverage">Beverage</option>
                    <option value="Frozen Food">Frozen Food</option>
                    <option value="Health & Wellness">Health & Wellness</option>
                    <option value="Pantry">Pantry</option>
                </select>
                <br>
                <div class="sub-category">
                    <label for="sub-category">Sub Category</label><br>
                    <select name="categories" id="sub-category">
                        <option value="Canned">Canned</option>
                        <option value="Cooking">Cooking</option>
                        <option value="Snacks">Snacks</option>
                        <option value="Add category" class="test">Add category</option>
                    </select>
                </div>
                <label for="manufactured">Manufactured Date</label>
                <input class="manufactured-date" id="manufactured" required type="date" name="manufactured">
                <label for="expiry-date">Expiry Date</label>
                <input class="expiry-date" id="expiry-date" required type="date" name="expiry-date">
                <input class="add-item" type="button" name="add-item" value="Add Item">
            </div>

        </div>

    </main>

    <div class="bottom-fix"></div>

    <section>
        <div class="menu-container">
            <div class="item-all-link bttm active-bttm"><img class="status-icn" src="./images/allitems_icon.png"
                    alt="img">
            </div>
            <div class="item-available-link bttm"><img class="status-icn" src="./images/available_icon.png" alt="img">
            </div>
            <div class="add-item-link bttm"><img class="mid-add" src="./images/add_icon.png" alt="img"></div>
            <div class="item-to-expire-link bttm"><img class="status-icn" src="./images/toexpired_icon.png" alt="img">
            </div>
            <div class="item-expired-link bttm"><img class="status-icn" src="./images/expired_icon.png" alt=""></div>
        </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-auth.js";
        import {
            getDatabase, ref, push, onValue, child,
            remove, set, query, orderByChild, get,
            startAt, endAt
        } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-database.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBlFt16zm2py8oMRZDoXtXQXlr7nW_WIB0",
            authDomain: "inventory-c9ef8.firebaseapp.com",
            databaseURL: "https://inventory-c9ef8-default-rtdb.firebaseio.com",
            projectId: "inventory-c9ef8",
            storageBucket: "inventory-c9ef8.appspot.com",
            messagingSenderId: "822020064388",
            appId: "1:822020064388:web:cb62ef0dab0d929d0c2ed1"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location = "index.html";
            }
        });

        //select logout class
        var buttonout = document.querySelectorAll(".signout");
        //logout function
        buttonout.forEach(out => {
            out.onclick = () => {
                auth.signOut();
            }
        })

        //add item link function section
        var add_link = document.querySelector(".add-item-link");
        add_link.addEventListener("click", openAdd);
        var add_bottom = document.querySelector(".add-item-bottom");
        add_bottom.addEventListener("click", openAdd);

        function openAdd() {
            var item_contain = document.querySelector(".items-container").style.display = "none";
            var add_contain = document.querySelector(".add-item-section");
            var menu = document.querySelector("main");
            var browsersize = window.innerWidth;
            var screensize = screen.width;
            menu.style.display = "block";
            add_contain.style.display = "block";
            add_contain.style.marginTop = "10px";
            if (screensize < 769 || browsersize < 769) {
                add_contain.style.width = "100%";
            }
            else {
                add_contain.style.width = "50%";
            }
        }

        //add box shadow when the container is clicked
        var bttmcontainer = document.querySelectorAll(".bttm");
        for (let i = 0; i < bttmcontainer.length; i++) {
            bttmcontainer[i].onclick = function () {
                var first_container = bttmcontainer[0];
                while (first_container) {
                    if (first_container.tagName === "DIV") {
                        first_container.classList.remove("active-bttm");
                    }
                    first_container = first_container.nextSibling;
                }
                this.classList.add("active-bttm");
            }
        }

        //search button function section
        var serch = document.querySelector(".search-button");
        serch.addEventListener("click", search);

        //select add item button class
        var add = document.querySelector(".add-item");
        //add item button function
        add.addEventListener("click", () => {
            const user = auth.currentUser;
            const item_id = push(child(ref(db), "User Items/" + user.uid + '/Items')).key;
            var item_name = document.querySelector(".item-name").value;
            var item_price = document.querySelector(".item-price").value;
            const category = document.querySelector("#category").value;
            var sub_category = document.querySelector("#sub-category").value;
            var manufactured = document.querySelector(".manufactured-date").value;
            var expiry = document.querySelector(".expiry-date").value;
            var d = new Date();
            var month = d.getMonth() + 1;
            var date = d.getUTCDate();
            var year = d.getUTCFullYear();

            if (item_name == "" || item_price == "" || manufactured == "") {
                alert("Please input all the data needed.");
            }
            else {
                expiry == "" ? expiry = "No Expiry Date" : expiry = expiry;
                category == "Pantry" ? sub_category : sub_category = null;
                push(ref(db, "User Items/" + user.uid + "/Items"), {
                    item_name: item_name,
                    item_price: "â‚± " + item_price,
                    category: category,
                    sub_category: sub_category,
                    manufactured: manufactured,
                    expiry: expiry,
                    added: year + "-" + month + "-" + date
                });
            }
        });

        function search() {
            const item_header = document.querySelector(".table-container");
            var seach_value = document.querySelector(".search").value;
            var reff = query(ref(db, "Items"), orderByChild("item_name"), startAt(seach_value), endAt(seach_value + "\uf8ff"));
            removeTable();
            if (seach_value) {
                item_header.style.display = "block";
                get(reff).then((snappy) => {
                    snappy.forEach(chld => {
                        var srchdata = chld.val();
                        var srchid = chld.key;
                        var srchname = srchdata.item_name;
                        var srchprice = srchdata.item_price;
                        var srchmanu = srchdata.manufactured;
                        var srchexp = srchdata.expiry;
                        var srchadd = srchdata.added;

                        var srchrow = document.createElement("tr");
                        var srchtd1 = document.createElement("td");
                        var srchtd2 = document.createElement("td");
                        var srchtd3 = document.createElement("td");
                        var srchtd4 = document.createElement("td");
                        var srchtd5 = document.createElement("td");
                        var srchtd6 = document.createElement("td");

                        srchtd1.innerHTML = srchid; srchtd2.innerHTML = srchname; srchtd3.innerHTML = srchprice;
                        srchtd4.innerHTML = srchmanu; srchtd5.innerHTML = srchexp; srchtd6.innerHTML = srchadd;

                        srchtd1.classList.add("iid");

                        srchrow.appendChild(srchtd1); srchrow.appendChild(srchtd2); srchrow.appendChild(srchtd3);
                        srchrow.appendChild(srchtd4); srchrow.appendChild(srchtd5); srchrow.appendChild(srchtd6);

                        var first = document.querySelector(".item-body");
                        first.appendChild(srchrow);
                    })
                })
            }
        };

        function getItemNumber() {
            setTimeout(() => {
                const all = {
                    all: 0,
                    exall: 0,
                    toxall: 0,
                    alltotal: 0
                }
                const beverages = {
                    beverage: 0,
                    exbeverage: 0,
                    toxbeverage: 0,
                    beveragetotal: 0
                }
                const frozen = {
                    frozen: 0,
                    exfrozen: 0,
                    toxfrozen: 0,
                    frozentotal: 0
                }
                const health = {
                    health: 0,
                    exhealth: 0,
                    toxhealth: 0,
                    healthtotal: 0
                }
                const pantry = {
                    pantry: 0,
                    expantry: 0,
                    toxpantry: 0,
                    pantrytotal: 0
                }

                var month = new Date().getMonth() + 1;
                var year = new Date().getFullYear();
                var day = new Date().getDate();
                const user = auth.currentUser;
                const reff = ref(db, "User Items/" + user.uid + "/Items");
                onValue(reff, (snapshot) => {
                    snapshot.forEach(item => {

                        const data = item.val();
                        const manufactured = data.manufactured;
                        const expiry = data.expiry;
                        const category = data.category;
                        var new_expiry = new Date(expiry);
                        var exdate_time = new_expiry.getTime();
                        exdate_time = exdate_time - 28800000;
                        var fulldate = month + "-" + day + "-" + year;
                        var transtodate = new Date(fulldate);
                        var crr_time = transtodate.getTime();
                        var near = crr_time - exdate_time;
                        var remain = Math.abs(Math.floor(near / (60 * 60 * 24)));
                        remain = remain / 1000;
                        console.log(remain);

                        crr_time >= exdate_time ? all.exall += 1 : all.all++;
                        remain <= 31 && remain > 0 ? all.toxall += 1 : all.toxall;
                        all.alltotal++;

                        switch (category) {
                            case "Beverage":
                                crr_time >= exdate_time ? beverages.exbeverage += 1 : beverages.beverage++;
                                remain <= 31 && remain > 0 ? beverages.toxbeverage += 1 : beverages.toxbeverage;
                                beverages.beveragetotal++;
                                break;
                            case "Frozen Food":
                                crr_time >= exdate_time ? frozen.exfrozen += 1 : frozen.frozen++;
                                remain <= 31 && remain > 0 ? frozen.toxfrozen += 1 : frozen.toxfrozen;
                                frozen.frozentotal++;
                                break;
                            case "Health & Wellness":
                                crr_time >= exdate_time ? health.exhealth += 1 : health.health++;
                                remain <= 31 && remain > 0 ? health.toxhealth += 1 : health.toxhealth;
                                health.healthtotal++;
                                break;
                            case "Pantry":
                                crr_time >= exdate_time ? pantry.expantry += 1 : pantry.pantry++;
                                remain <= 31 && remain > 0 ? pantry.toxpantry += 1 : pantry.toxpantry;
                                pantry.pantrytotal++;
                                break;
                            default:
                                alert("Error getting category number");
                                break;
                        }
                    });
                    createChart(all, beverages, frozen, health, pantry);
                });
            }, 1000);
        }

        function createChart(all, beverages, frozen, health, pantry) {
            setTimeout(() => {
                const ctx = document.getElementById('myChart');

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ["Beverage", "Frozen Food", "Health & Wellness", "Pantry", "All Items"],
                        datasets: [
                            {
                                label: 'Available',
                                data: [all.all, beverages.beverage, frozen.frozen, health.health, pantry.pantry],
                                borderWidth: 1,
                                tension: 0.1
                            },
                            {
                                label: 'Expired',
                                data: [all.exall, beverages.exbeverage, frozen.exfrozen, health.exhealth, pantry.expantry],
                                borderWidth: 1,
                                tension: 0.1
                            },
                            {
                                label: 'To Expire',
                                data: [all.toxall, beverages.toxbeverage, frozen.toxfrozen, health.toxhealth, pantry.toxpantry],
                                borderWidth: 1,
                                tension: 0.1
                            },
                            {
                                label: 'Total',
                                data: [all.alltotal, beverages.beveragetotal, frozen.frozentotal, health.healthtotal, pantry.pantrytotal],
                                borderWidth: 1,
                                tension: 0.1
                            }
                        ]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    },
                    titlle: {
                        display: true,
                        text: 'Items'
                    }
                });
            }, 1000);
        }
        getItemNumber();
    </script>
    <script src="./index.js"></script>
</body>

</html>